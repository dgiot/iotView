(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-9842fbe6"],{"053f":function(e,t,a){},"05d6":function(e,t,a){"use strict";a("1754")},"11ac":function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"baidumap",style:{width:"100%",height:"100%"}},[e.mapFlag?a("baidu-map",{staticClass:"baidu_map",attrs:{id:"baidu_map",ak:e.ak,center:e.center,"scroll-wheel-zoom":!0,zoom:e.sizeZoom},on:{ready:e.handler,click:e.handleMapClick}},[a("bm-map-type",{attrs:{anchor:"BMAP_ANCHOR_TOP_LEFT","map-types":["BMAP_HYBRID_MAP","BMAP_NORMAL_MAP"]}}),a("bm-overview-map",{attrs:{"is-open":!0}}),a("bm-scale",{attrs:{offset:{width:260,height:0}}}),a("bm-city-list",{attrs:{offset:{width:330,height:0}}}),a("bml-marker-clusterer",{attrs:{"average-center":!0}},e._l(e.deviceList,(function(t,n){return a("div",{key:n},[a("bm-marker",{ref:"bm_info"+n,refInFor:!0,attrs:{position:{lng:t.location.longitude,lat:t.location.latitude}},on:{click:function(a){return e.showDeatils(t,n)}}},[a("bm-info-window",{key:n,staticStyle:{display:"none"},attrs:{position:{lng:t.location.longitude,lat:t.location.latitude},show:t.show},on:{close:function(a){return e.closeInfo(t,n)}}},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.deviceInfo,expression:"deviceInfo"}],staticClass:"deviceInfo",staticStyle:{width:"400px"}},[a("el-row",{attrs:{gutter:24}},[a("el-col",{attrs:{span:24}},[a("div",{staticStyle:{display:"flex","justify-content":"space-between"}},[a("h2",{staticStyle:{"font-weight":"600"}},[e._v(e._s(e.deviceInfo.name))]),a("el-link",{staticStyle:{"margin-right":"16px"},attrs:{type:"ONLINE"===e.deviceInfo.status?"success":"danger",underline:!1}},[a("span",{staticClass:"circle",class:"ONLINE"===e.deviceInfo.status?"success":"warning"}),e._v(" "+e._s("ONLINE"===e.deviceInfo.status?"在线":"离线")+" ")])],1),a("div",{staticStyle:{color:"#ccc"}},[e._v(" 编号："+e._s(e.deviceInfo.devaddr)+" ")]),a("div",{staticStyle:{color:"#ccc"}},[e._v(" 位置："+e._s(e.deviceInfo.address)+" ")]),a("p",[a("el-button",{attrs:{type:"success"},on:{click:function(t){return e.handleOpenRealCard(e.deviceInfo)}}},[e._v(" 实时数据 ")]),a("el-button",{on:{click:function(t){return e.handleOpenTopo(e.deviceInfo)}}},[e._v(" 组态 ")])],1)])],1)],1)])],1)],1)})),0)],1):e._e(),a("el-dialog",{staticClass:"device_wrap",attrs:{title:e.deviceInfo.name,"append-to-body":!0,top:"10vh",visible:e.dialogDeviceVisible},on:{close:e.handlecloseDevice,"update:visible":function(t){e.dialogDeviceVisible=t}}},[a("real-card",{attrs:{cardList:e.cardList,avator:e.avator}})],1),e.dialogTopoVisible?a("div",{staticClass:"topo_wrap"},[a("div",{staticClass:"topo_contentwrap"},[a("div",{staticClass:"topo_title_top"},[a("div",[e._v(e._s(e.deviceInfo.name))]),a("span",{staticStyle:{cursor:"pointer"},on:{click:e.closeTopo}},[e._v("x")])]),a("div",{staticClass:"topo_content"},[a("topo-device",{staticClass:"wrap_konva",attrs:{deviceInfo:e.deviceInfo}})],1)])]):e._e(),e.dialogTopoAmisVisible?a("el-dialog",{attrs:{top:"10vh","append-to-body":!0,width:"1240px",visible:e.dialogTopoAmisVisible},on:{close:e.handlecloseDevice,"update:visible":function(t){e.dialogTopoAmisVisible=t}}},[a("amis",{attrs:{"modal-append-to-body":"",schema:e.topoAmisData,"show-help":!1}})],1):e._e()],1)},i=[],r=a("2909"),o=a("c7eb"),c=a("1da1"),s=(a("d81d"),a("ace4"),a("d3b7"),a("5cc6"),a("907a"),a("9a8c"),a("a975"),a("735e"),a("c1ac"),a("d139"),a("3a7b"),a("986a"),a("1d02"),a("d5d6"),a("82f8"),a("e91f"),a("60bd"),a("5f96"),a("3280"),a("3fcc"),a("ca91"),a("25a1"),a("cd26"),a("3c5d"),a("2954"),a("649e"),a("219c"),a("170b"),a("b39a"),a("1b3b"),a("3d71"),a("72f7"),a("c6e3"),a("b64b"),a("159b"),a("7db0"),a("498a"),a("b0c0"),a("14d9"),a("caad"),a("2532"),a("6062"),a("3ca3"),a("ddb0"),a("bd0c")),l=a("90be"),d=a("264a"),u=a("c7d9"),p=a("ae53"),f=a("fca4"),v=a("ad0f"),h=a("a598"),m=a("e6a3"),b=a("a458"),g=a("9f28"),y=a("624b"),w=a("1285"),x=a("59d7"),_=a.n(x),k=a("e762"),j=a("39c4"),O=a("8ba7"),I={name:"ScreenBaidumap",components:{BmPointCollection:s["BmPointCollection"],BmInfoWindow:s["BmInfoWindow"],BmScale:s["BmScale"],BmMapType:s["BmMapType"],BmOverviewMap:s["BmOverviewMap"],BmPanorama:s["BmPanorama"],BmControl:s["BmControl"],BmLabel:s["BmLabel"],BaiduMap:s["BaiduMap"],BmNavigation:s["BmNavigation"],BmGeolocation:s["BmGeolocation"],BmCityList:s["BmCityList"],BmMarker:s["BmMarker"],BmlMarkerClusterer:s["BmlMarkerClusterer"],BmPolyline:s["BmPolyline"],RealCard:l["a"],amis:h["a"],TopoCaltable:u["a"],ScreenDevice:p["a"],ScreenRealcard:v["a"],WorkOrder:f["a"],DgiotAliplayer:d["a"],ScreenLine:m["a"],ScreenDeviceBar:b["a"],DgiotNotification1:y["a"],TopoDevice:g["a"]},props:{comp:{type:Object,default:function(){return{type:"line",width:400,hieght:72}}}},emits:["initScreen"],data:function(){return{avator:_.a,dialogDeviceVisible:!1,dialogTopoVisible:!1,ak:"S7pehghn5BdQeSGZAcpEk4bLQSQ8czvi",sizeZoom:12,mapFlag:!1,center:{lng:120.260545,lat:31.551162},deviceList:[],cardList:[],productIco:"",deviceInfo:{},devicetopo:{},devicelayer:"",devicestage:"",vueComponents:[],amisComponents:[],vueFlag:!1,amisFlag:!1,dialogTopoAmisVisible:!1,topoAmisData:{},styleJson:[{featureType:"water",elementType:"all",stylers:{color:"#021019"}},{featureType:"highway",elementType:"geometry.fill",stylers:{color:"#000000"}},{featureType:"highway",elementType:"geometry.stroke",stylers:{color:"#147a92"}},{featureType:"arterial",elementType:"geometry.fill",stylers:{color:"#000000"}},{featureType:"arterial",elementType:"geometry.stroke",stylers:{color:"#0b3d51"}},{featureType:"local",elementType:"geometry",stylers:{color:"#000000"}},{featureType:"land",elementType:"all",stylers:{color:"#08304b"}},{featureType:"railway",elementType:"geometry.fill",stylers:{color:"#000000"}},{featureType:"railway",elementType:"geometry.stroke",stylers:{color:"#08304b"}},{featureType:"subway",elementType:"geometry",stylers:{lightness:-70}},{featureType:"building",elementType:"geometry.fill",stylers:{color:"#000000"}},{featureType:"all",elementType:"labels.text.fill",stylers:{color:"#857f7f"}},{featureType:"all",elementType:"labels.text.stroke",stylers:{color:"#000000"}},{featureType:"building",elementType:"geometry",stylers:{color:"#022338"}},{featureType:"green",elementType:"geometry",stylers:{color:"#062032"}},{featureType:"boundary",elementType:"all",stylers:{color:"#1e1c1c"}},{featureType:"manmade",elementType:"geometry",stylers:{color:"#022338"}},{featureType:"poi",elementType:"all",stylers:{visibility:"off"}},{featureType:"all",elementType:"labels.icon",stylers:{visibility:"off"}},{featureType:"all",elementType:"labels.text.fill",stylers:{color:"#2da0c6",visibility:"on"}}]}},created:function(){var e=this;return Object(c["a"])(Object(o["a"])().mark((function t(){return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.comp.text&&(e.ak=e.comp.text);case 1:case"end":return t.stop()}}),t)})))()},mounted:function(){var e=this;return Object(c["a"])(Object(o["a"])().mark((function t(){return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.queryDevice();case 2:e.mapFlag=!0,e.$dgiotBus.$off("device/transmit"),e.$dgiotBus.$on("device/transmit",(function(t){console.log("接受了",t),e.center={lng:t.location.longitude,lat:t.location.latitude},e.sizeZoom=15}));case 5:case"end":return t.stop()}}),t)})))()},methods:{handler:function(e){e.BMap;var t=e.map;t.setMapType(BMAP_HYBRID_MAP)},closeTopo:function(){this.amisFlag=!1,this.vueFlag=!1,this.dialogTopoVisible=!1,this.$emit("initScreen")},handleOpenTopo:function(e){var t=this;return Object(c["a"])(Object(o["a"])().mark((function a(){var n,i,r,c,s,l;return Object(o["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return i={count:"objectId",order:"-updatedAt",excludeKeys:"data",skip:0,where:{class:{$regex:"Product"},type:{$regex:"Topo"},key:{$regex:e.product.objectId}}},localStorage.setItem("parse_objectId",e.objectId),t.vueComponents=[],t.amisComponents=[],a.next=6,Object(O["d"])(i);case 6:if(r=a.sent,console.log("组态",r),0!=r.results.length){a.next=11;break}return t.$message("暂未配置组态"),a.abrupt("return");case 11:return c={productid:e.product.objectId,devaddr:e.devaddr,viewid:(null===(n=r.results[0])||void 0===n?void 0:n.objectId)||""},a.next=14,Object(O["a"])(c);case 14:s=a.sent,t.devicetopo=s.data.Stage,l={topic:"$dg/user/konva/".concat(e.objectId,"/report")},t.dialogTopoVisible=!0,console.log("this.deviceInfo",t.deviceInfo),t.sendTopic(l),setTimeout((function(){t.initDeviceKonva()}),2e3);case 21:case"end":return a.stop()}}),a)})))()},initDeviceKonva:function(){var e=this;this.devicelayer=Konva.Node.create(this.devicetopo,"deviceTopo").findOne("Layer"),this.devicestage=new Konva.Stage({container:"deviceTopo",width:1200,height:700}),this.devicestage.add(this.devicelayer),this.$dgiotBus.$off("$dg/user/konva"),this.$dgiotBus.$on("$dg/user/konva",(function(t){var a=String.fromCharCode.apply(null,new Uint8Array(t)),n=JSON.parse(k["a"].decode(a));console.log(n),n.konva.forEach((function(t){e.putNode(e.devicestage,t.id,t.text,t.type)}))})),this.handleInitKonva()},putNode:function(e,t,a,n){if("undefined"!=n){var i={};i[n]=a,console.log(t,a),e.find("#".concat(t)).forEach((function(e){console.log(e),e.setAttrs(i)})),this.devicelayer.batchDraw()}},handleInitKonva:function(){var e=this;return Object(c["a"])(Object(o["a"])().mark((function t(){var a,n,i,r;return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:a=[],n=[],e.devicestage.find("Label").forEach((function(e){e.setAttrs({draggable:!1})})),e.devicestage.find("Text").forEach((function(t){t.setAttrs({draggable:!1}),t.on("touchend",function(){var a=Object(c["a"])(Object(o["a"])().mark((function a(n){var i,r,c;return Object(o["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(console.log("touchend",t),!t.attrs.bind_amis){a.next=11;break}return localStorage.setItem("parse_objectid",e.deviceInfo.objectId),localStorage.setItem("parse_productid",e.deviceInfo.product.objectId),i={viewid:t.attrs.amis_id},r={render:{text:t.attrs.text.trim()}},a.next=8,Object(O["c"])(i,r);case 8:c=a.sent,e.topoAmisData=c.data,e.dialogTopoAmisVisible=!0;case 11:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}()),t.on("click",function(){var a=Object(c["a"])(Object(o["a"])().mark((function a(n){var i,r,c;return Object(o["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(console.log("click",t),!t.attrs.bind_amis){a.next=11;break}return localStorage.setItem("parse_objectid",e.deviceInfo.objectId),localStorage.setItem("parse_productid",e.deviceInfo.product.objectId),i={viewid:t.attrs.amis_id},r={render:{text:t.attrs.text.trim()}},a.next=8,Object(O["c"])(i,r);case 8:c=a.sent,e.topoAmisData=c.data,e.dialogTopoAmisVisible=!0;case 11:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}())})),e.devicestage.find("Image").forEach((function(t){if(t.setAttrs({draggable:!1}),"konvaimage"==t.attrs.type||"vuecomponent"==t.attrs.name){var i=t.attrs;a.push(i)}else if("amiscomponent"==t.attrs.name){var r=t.attrs;n.push(r)}else if(t.attrs.id.indexOf("不")<0){var o=new Image;t.setAttrs({image:o}),o.src=t.attrs.src.includes("//")?t.attrs.src:e.$FileServe+t.attrs.src}})),e.devicestage.find("Rect").forEach((function(e){if(e.setAttrs({draggable:!1}),"vuecomponent"==e.attrs.name){var t=e.attrs;a.push(t)}else if("amiscomponent"==e.attrs.name){var i=e.attrs;n.push(i)}})),e.devicelayer.batchDraw(),setTimeout((function(){console.log("第一次重绘"),e.devicelayer.batchDraw()}),500),setTimeout((function(){console.log("第二次重绘"),e.devicelayer.batchDraw()}),1e3),e.vueComponents=a,e.vueFlag=!0,e.amisComponents=n,i=0;case 13:if(!(i<e.amisComponents.length)){t.next=21;break}return t.next=16,Object(O["b"])(e.amisComponents[i].id);case 16:r=t.sent,e.amisComponents[i].viewData=r.data.data;case 18:i++,t.next=13;break;case 21:e.amisFlag=!0;case 22:case"end":return t.stop()}}),t)})))()},handlecloseDevice:function(){console.log("关闭实时数据弹窗"),this.$emit("initScreen")},handleOpenRealCard:function(e){var t=this;return Object(c["a"])(Object(o["a"])().mark((function a(){var n,i;return Object(o["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,Object(w["b"])(e.objectId);case 2:n=a.sent,t.cardList=t.renderCard(n.data),console.log("thiscardList",t.cardList),i={topic:"$dg/user/realtimecard/".concat(e.objectId,"/report")},t.$dgiotBus.$off("$dg/user/realtimecard/".concat(e.objectId)),t.$dgiotBus.$on("$dg/user/realtimecard/".concat(e.objectId),(function(e){var a=String.fromCharCode.apply(null,new Uint8Array(e)),n=JSON.parse(k["a"].decode(a));console.log("实时卡片 ",n),t.cardList=t.renderCard(n.data)})),t.sendTopic(i),t.dialogDeviceVisible=!0;case 10:case"end":return a.stop()}}),a)})))()},sendTopic:function(e){Object(j["d"])(e).then((function(e){console.log(e)}))},renderCard:function(e){var t=[];e.forEach((function(e){e.devicetype=""===e.devicetype?"default":e.devicetype,e.devicetype&&t.push(e.devicetype)})),t=Object(r["a"])(new Set(t)),console.log("类别",t);var a=[];return t.forEach((function(t){var n={},i=[];e.forEach((function(e){t==e.devicetype&&i.push(e)})),n["data"]=i,n["name"]=t,a.push(n)})),a},closeInfo:function(e,t){e.show=!1},showDeatils:function(e,t){var a=this;return Object(c["a"])(Object(o["a"])().mark((function n(){return Object(o["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a.productIco="",n.next=3,Object(w["a"])(e.objectId);case 3:a.deviceInfo=n.sent,console.log("this.deviceInfo",a.deviceInfo),a.$dgiotBus.$emit("device/historylinedata",e),a.$dgiotBus.$emit("device/historybardata",e),a.deviceList[t].show=!0;case 8:case"end":return n.stop()}}),n)})))()},queryDevice:function(){var e=this;return Object(c["a"])(Object(o["a"])().mark((function t(){var a,n,i,r,c,s;return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={skip:0,order:"-createdAt",count:"objectId",where:{},limit:10},t.next=3,Object(w["e"])(a);case 3:n=t.sent,i=n.results,r=void 0===i?[]:i,c=n.count,void 0===c?0:c,s=!0,r.forEach((function(t){var a,n,i,r;(t.address=""==t.address||void 0==t.address?"---":t.address,t.show=!1,s&&null!==(a=t.location)&&void 0!==a&&a.latitude&&null!==(n=t.location)&&void 0!==n&&n.longitude)&&(e.center={lng:null===(i=t.location)||void 0===i?void 0:i.longitude,lat:null===(r=t.location)||void 0===r?void 0:r.latitude},s=!1)})),e.deviceList=r;case 11:case"end":return t.stop()}}),t)})))()},handleMapClick:function(e){return Object(c["a"])(Object(o["a"])().mark((function t(){var a;return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:console.log("单击地图事件",e),a={__type:"GeoPoint",latitude:e.point.lat,longitude:e.point.lng},{limit:10,where:{location:{$nearSphere:a,$maxDistanceInMiles:10}}};case 3:case"end":return t.stop()}}),t)})))()}}},S=I,T=(a("05d6"),a("2877")),$=Object(T["a"])(S,n,i,!1,null,"bd59cce8",null);t["a"]=$.exports},1754:function(e,t,a){},"32db":function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"topoPie",style:{width:e.comp.width+"px",height:e.comp.height+"px"}},[a("div",{staticClass:"screen_right_bottom_top"},[e._v("设备状况占比")]),a("ve-pie",{attrs:{data:e.chartData,extend:e.extend,height:"100%",settings:e.chartSettings,width:"100%"}})],1)},i=[],r=a("c7eb"),o=a("1da1"),c=a("5530"),s=(a("99af"),a("ace4"),a("d3b7"),a("5cc6"),a("907a"),a("9a8c"),a("a975"),a("735e"),a("c1ac"),a("d139"),a("3a7b"),a("986a"),a("1d02"),a("d5d6"),a("82f8"),a("e91f"),a("60bd"),a("5f96"),a("3280"),a("3fcc"),a("ca91"),a("25a1"),a("cd26"),a("3c5d"),a("2954"),a("649e"),a("219c"),a("170b"),a("b39a"),a("1b3b"),a("3d71"),a("72f7"),a("c6e3"),a("b64b"),a("2f62")),l={name:"TopoPie",props:{comp:{type:Object,default:function(){return{type:"line",width:200,hieght:120}}}},data:function(){return this.chartSettings={type:"pie"},this.extend={series:{type:"pie",radius:["20%","50%"],center:["50%","50%"],itemStyle:{borderRadius:2,borderColor:"#fff",borderWidth:1}},legend:{textStyle:{color:"#fff"}},xAxis:{axisLine:{lineStyle:{color:"#fff"}}},yAxis:{axisLine:{lineStyle:{color:"#fff"}}}},{top:10,chartData:{columns:["名称","数量"],rows:[{"名称":"产品","数量":8},{"名称":"设备","数量":0},{"名称":"告警数","数量":15}]},timer:""}},computed:Object(c["a"])({},Object(s["b"])(["_dev_online_count","_dev_off_count"])),watch:{},created:function(){this.chartData={columns:["名称","数量"],rows:[{"名称":"开机数","数量":0},{"名称":"关机数","数量":0}]}},mounted:function(){var e=this;this.topic="/".concat(this.comp.type,"/").concat(this.comp.id,"/report"),this.$dgiotBus.$off(this.topic),this.$dgiotBus.$on(this.topic,(function(t){var a=String.fromCharCode.apply(null,new Uint8Array(t)),n=JSON.parse(Base64.decode(a));e.chartData=n,e.text=n.lable,e.value=n.value}))},destroyed:function(){clearInterval(this.timer)},methods:{queryChart:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return n=(new Date).getTime(),i=n-6048e5,o={starttime:i,endtime:n,interval:"30m",keys:"*",limit:50,function:"last",style:"line"},a.next=5,getDabDevice(e,o).then((function(e){var a;if(console.log(e,"res charts"),(null===e||void 0===e||null===(a=e.chartData)||void 0===a?void 0:a.rows.length)>0){var n=e.chartData,i=void 0===n?{}:n;t.chartData=i,t.$nextTick((function(){setTimeout((function(){t.loading=!0,t.toggleChart("line")}),1e3)}))}console.log("this.chartData",t.chartData),t.loading=!1,t.dataEmpty=!1})).catch((function(e){console.log(e),t.loading=!1}));case 5:case"end":return a.stop()}}),a)})))()}}},d=l,u=(a("f2aa"),a("2877")),p=Object(u["a"])(d,n,i,!1,null,"e85dfd2c",null);t["a"]=p.exports},3304:function(e,t,a){"use strict";a("d690")},"38bc":function(e,t,a){},"425e":function(e,t,a){"use strict";a("9045")},5335:function(e,t,a){"use strict";a("053f")},"55f4":function(e,t,a){"use strict";a("cb78")},"5f51":function(e,t,a){},"5fa9":function(e,t,a){"use strict";a("a28f")},"766c":function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticStyle:{width:"100%",height:"100%"},attrs:{id:"map"}})},i=[],r=a("c7eb"),o=a("1da1"),c=(a("d81d"),{name:"ScreenSgmap",components:{},props:{comp:{type:Object,default:function(){return{type:"line",width:400,hieght:72}}}},emits:["initScreen"],data:function(){return{map:{}}},created:function(){return Object(o["a"])(Object(r["a"])().mark((function e(){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},mounted:function(){var e=this;SGMap.tokenTask.login("8a2d9f94f4ae3df2ba80b2f9df8970e5","1d154b90b347326b9622c510d170e707").then((function(){e.initMap()})).catch((function(e){console.log(e)}))},methods:{initMap:function(){this.map=new SGMap.Map({container:"map",style:"aegis://styles/aegis/Streets-v2",center:[120.06219,30.3602],zoom:16,localIdeographFontFamily:"Microsoft YoHei"}),console.log("init map",this.map)}}}),s=c,l=a("2877"),d=Object(l["a"])(s,n,i,!1,null,null,null);t["a"]=d.exports},9045:function(e,t,a){},a28f:function(e,t,a){},a434:function(e,t,a){"use strict";var n=a("23e7"),i=a("7b0b"),r=a("23cb"),o=a("5926"),c=a("07fa"),s=a("3511"),l=a("65f0"),d=a("8418"),u=a("083a"),p=a("1dde"),f=p("splice"),v=Math.max,h=Math.min;n({target:"Array",proto:!0,forced:!f},{splice:function(e,t){var a,n,p,f,m,b,g=i(this),y=c(g),w=r(e,y),x=arguments.length;for(0===x?a=n=0:1===x?(a=0,n=y-w):(a=x-2,n=h(v(o(t),0),y-w)),s(y+a-n),p=l(g,n),f=0;f<n;f++)m=w+f,m in g&&d(p,f,g[m]);if(p.length=n,a<n){for(f=w;f<y-n;f++)m=f+n,b=f+a,m in g?g[b]=g[m]:u(g,b);for(f=y;f>y-n+a;f--)u(g,f-1)}else if(a>n)for(f=y-n;f>w;f--)m=f+n-1,b=f+a-1,m in g?g[b]=g[m]:u(g,b);for(f=0;f<a;f++)g[f+w]=arguments[f+2];return g.length=y-n+a,p}})},aa38:function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"topoCard",style:{width:e.comp.width+"px",height:e.comp.height+"px"}},[a("div",{staticClass:"card_content"},[a("div",{staticStyle:{"font-size":"1.25em","text-shadow":"1px 2px 0.5px #000"}},[a("span",{staticStyle:{"font-weight":"bold"}},[e._v(e._s(e.label)+": ")]),a("span",{staticStyle:{color:"#efdb64"}},[e._v(e._s(e.value))])])])])},i=[],r=a("5530"),o=(a("99af"),a("ace4"),a("d3b7"),a("5cc6"),a("907a"),a("9a8c"),a("a975"),a("735e"),a("c1ac"),a("d139"),a("3a7b"),a("986a"),a("1d02"),a("d5d6"),a("82f8"),a("e91f"),a("60bd"),a("5f96"),a("3280"),a("3fcc"),a("ca91"),a("25a1"),a("cd26"),a("3c5d"),a("2954"),a("649e"),a("219c"),a("170b"),a("b39a"),a("1b3b"),a("3d71"),a("72f7"),a("c6e3"),a("b64b"),a("e9c4"),a("e762")),c=a("2f62"),s=a("5f87"),l={name:"TopoCard",props:{comp:{type:Object,default:function(){return{type:"line",width:262,hieght:72}}}},computed:Object(r["a"])({},Object(c["b"])(["_product_count","_dev_count","_dev_online_count","_dev_off_count"])),data:function(){return{value:0,topic:"",label:""}},created:function(){},mounted:function(){var e=this;this.label=this.comp.text,this.topic="/".concat(this.comp.type,"/").concat(this.comp.id,"/report"),this.$dgiotBus.$off(this.topic),this.$dgiotBus.$on(this.topic,(function(t){var a=String.fromCharCode.apply(null,new Uint8Array(t)),n=JSON.parse(o["a"].decode(a));console.log(e.comp.type,"接收到了数据=>",n);var i=Object(s["a"])(),r="$dg/user/dashboard/".concat(i,"/ack"),c={ack:"heartbeat"};e.$dgiotBus.$emit("MqttPublish",{pubTopic:r,message:JSON.stringify(c),qs:0,status:!1}),e.text=n.lable,e.value=n.value}))},destroyed:function(){this.$dgiotBus.$off(this.topic)}},d=l,u=(a("d03f"),a("2877")),p=Object(u["a"])(d,n,i,!1,null,"7906aafa",null);t["a"]=p.exports},b305:function(e,t,a){},b34f:function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"realtime",style:{width:"100%",height:"100%"}},[e._v(" "+e._s(e.nowTime)+" ")])},i=[],r=a("ed08"),o={name:"RealTime",data:function(){return{timer:"",nowTime:""}},mounted:function(){var e=this;this.timer=setInterval((function(){e.datetime()}),1e3)},methods:{datetime:function(){this.nowTime=Object(r["a"])()}},destroyed:function(){clearInterval(this.timer)}},c=o,s=(a("5335"),a("2877")),l=Object(s["a"])(c,n,i,!1,null,"3d9d6c7c",null);t["a"]=l.exports},c006:function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"screenheaditem",style:{width:"100%",height:"100%"}},[a("div",{staticClass:"count_item",style:{color:e.comp.color||"#fff"},on:{click:e.handleTo}},[a("div",{staticClass:"count_item_head"},[a("div",{staticClass:"count_item_head_left"},[a("div",{staticStyle:{"font-size":"1.5em"}},[e._v(e._s(e.item.name))]),a("div",{staticStyle:{"font-size":"5em"}},[e._v(e._s(e.item.number))])]),a("div",{staticClass:"count_item_head_right"},[a("el-progress",{attrs:{color:e.comp.color||"#409eff",type:"circle","stroke-width":10,percentage:e.item.percent}})],1)]),a("div",{staticClass:"count_item_foot"},[a("div",{staticClass:"count_item_foot_left"},[a("div",{staticStyle:{width:"100%"}},[a("span",{staticClass:"circle success"}),e._v(" "),a("span",[e._v(e._s(e.item.finename))])]),a("div",[e._v(e._s(e.item.finenumber))])]),a("div",{staticClass:"count_item_foot_center"}),a("div",{staticClass:"count_item_foot_right"},[a("div",{staticStyle:{width:"100%"}},[a("span",{staticClass:"circle warning"}),e._v(" "),a("span",[e._v(e._s(e.item.badname))])]),a("div",[e._v(e._s(e.item.badnumber))])])])])])},i=[],r=a("c7eb"),o=a("1da1"),c=(a("b0c0"),a("14d9"),a("d3b7"),a("159b"),a("a9e3"),a("b680"),a("1285")),s=a("b775");function l(e){return Object(s["a"])({url:"/classes/Product",method:"get",params:e})}var d=a("4569"),u=a("d76c"),p={name:"ScreenHeadcount",props:{comp:{type:Object,default:function(){return{type:"line",width:400,hieght:72}}}},data:function(){return{item:{name:"产品数量",number:0,finename:"正常",finenumber:0,badname:"停用",badnumber:0}}},created:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:console.log("comp",e.comp),"product_count"==e.comp.id?(e.item.name="产品数量",e.item.finename="正常",e.item.badname="停用",e.queryProduct()):"device_count"==e.comp.id?(e.item.name="设备数量",e.item.finename="在线",e.item.badname="离线",e.queryDevice()):"warning_count"==e.comp.id?(e.item.name="告警数量",e.item.finename="已处理",e.item.badname="未处理",e.queryNotification()):"order_count"==e.comp.id&&(e.item.name="工单数量",e.item.finename="已处理",e.item.badname="未处理",e.getMaintenance());case 2:case"end":return t.stop()}}),t)})))()},mounted:function(){},methods:{handleTo:function(){this.comp.text&&this.$router.push({path:this.comp.text})},getMaintenance:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i,o,c,s;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={skip:0,order:"-createdAt",count:"objectId",where:{}},t.next=3,Object(u["a"])(a);case 3:n=t.sent,i=n.results,o=n.count,e.item.number=o,c=0,s=0,i.forEach((function(e){"2"==e.status?c++:s++})),e.item.finenumber=c,e.item.badnumber=s,e.item.percent=e.item.number>0?Number((e.item.finenumber/e.item.number*100).toFixed(1)):0;case 12:case"end":return t.stop()}}),t)})))()},queryNotification:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i,o,c,s;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={skip:0,order:"-createdAt",count:"objectId",where:{}},t.next=3,Object(d["a"])(a);case 3:n=t.sent,i=n.results,o=n.count,e.item.number=o,c=0,s=0,i.forEach((function(e){"0"==e.status?s++:c++})),e.item.finenumber=c,e.item.badnumber=s,e.item.percent=e.item.number>0?Number((e.item.finenumber/e.item.number*100).toFixed(1)):0;case 12:case"end":return t.stop()}}),t)})))()},queryProduct:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={skip:0,order:"-createdAt",count:"objectId",where:{}},t.next=3,l(a);case 3:n=t.sent,n.results,i=n.count,e.item.number=i,e.item.finenumber=i,e.item.percent=e.item.number>0?Number((e.item.finenumber/e.item.number*100).toFixed(1)):0;case 9:case"end":return t.stop()}}),t)})))()},queryDevice:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i,o,s,l;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={skip:0,order:"-createdAt",count:"objectId",where:{}},t.next=3,Object(c["e"])(a);case 3:n=t.sent,i=n.results,o=n.count,e.item.number=o,s=0,l=0,i.forEach((function(e){"ONLINE"==e.status?s++:l++})),e.item.finenumber=s,e.item.badnumber=l,e.item.percent=e.item.number>0?Number((e.item.finenumber/e.item.number*100).toFixed(1)):0;case 12:case"end":return t.stop()}}),t)})))()}}},f=p,v=(a("55f4"),a("2877")),h=Object(v["a"])(f,n,i,!1,null,"42fce4da",null);t["a"]=h.exports},cb78:function(e,t,a){},cc89:function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"custom-table",staticClass:"index-container"},[e.dialog?a("div",{directives:[{name:"show",rawName:"v-show",value:e.dialog,expression:"dialog"}],staticClass:"dialog_wrap"},["Konva"===e.showType?a("topo-screen",{attrs:{viewInfo:e.viewInfo}}):a("amis",{attrs:{"modal-append-to-body":"",schema:e.viewData,"show-help":!1}})],1):e._e(),e.dialogEvidenceVisible?a("el-dialog",{staticClass:"topo_wrap",attrs:{title:e.receiceEvidence.name,fullscreen:!0,"append-to-body":!0,visible:e.dialogEvidenceVisible},on:{close:e.handlecloseEvidence,"update:visible":function(t){e.dialogEvidenceVisible=t}}},[a("div",{staticClass:"evidence_body"},[a("el-header",{staticClass:"evidence_header"},[a("el-row",{staticClass:"evidence_header_row",attrs:{gutter:24}},[a("el-col",{attrs:{lg:1,md:1,sm:1,title:"检测详情",xl:1,xs:1}},[a("el-button",{attrs:{round:"",size:"mini",type:"success"},nativeOn:{click:function(t){e.asideShow=!e.asideShow}}},[e._v(" 检测详情 ")])],1)],1)],1),e.dialogEvidenceVisible?a("topo-evicence",{staticClass:"evidence_container",attrs:{deviceInfo:e.receiceEvidence,query:e.query,asideShow:e.asideShow},on:{reloadCurrent:e.reloadCurrent}}):e._e()],1)]):e._e(),a("el-drawer",{attrs:{"append-to-body":"",size:"90%",visible:e.reportDialog},on:{"update:visible":function(t){e.reportDialog=t}}},[a("iframe",{staticStyle:{width:"100%",height:"100%"},attrs:{src:e.officeapps}})]),e.dialogTopoVisible?a("div",{staticClass:"topo_wrap"},[a("div",{staticClass:"topo_contentwrap"},[a("div",{staticClass:"topo_title_top"},[a("div",[e._v(e._s(e.deviceInfo.name))]),a("span",{staticStyle:{cursor:"pointer"},on:{click:e.closeTopo}},[e._v("x")])]),a("topo-device",{attrs:{deviceInfo:e.deviceInfo}})],1)]):e._e(),a("el-drawer",{attrs:{"append-to-body":"",visible:e.visible,size:"100%"},on:{close:function(t){return e.saveHistorical(e.collectionInfo,e.thingcolumns,e.thingdata,!0)}}},[a("div",{directives:[{name:"infinite-scroll",rawName:"v-infinite-scroll",value:!0,expression:"true"}],style:{overflow:"auto",height:e.maxheight+"px"}},[a("el-row",{attrs:{gutter:24}},[a("el-col",{attrs:{span:12}},[a("el-divider",[e._v("采集数据")]),a("el-table",{key:e.thingdata.length,staticStyle:{"min-height":"280px"},attrs:{border:"",data:e.thingdata}},[a("el-table-column",{attrs:{align:"center",label:"序号","show-overflow-tooltip":"",width:"50"},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.$index;return[e._v(" "+e._s(a+1)+" ")]}}])}),e._l(e.thingcolumns,(function(e,t){return a("el-table-column",{key:t,attrs:{align:"center",label:e.label,prop:e.prop,"show-overflow-tooltip":"",sortable:"",width:"auto"}})}))],2)],1),e.collectionInfo.name?a("el-col",{attrs:{span:12}},[a("el-divider",[e._v("检测信息")]),a("el-card",[a("div",{staticClass:"setting"},[a("el-button",{attrs:{type:"success"},nativeOn:{click:function(t){return e.collection(e.collectionInfo)}}},[e._v(" 采集数据 ")]),a("el-button",{attrs:{type:"primary"},nativeOn:{click:function(t){return e.drawxnqx(e.collectionInfo.objectId,e.thingdata)}}},[e._v(" 存储数据 ")]),a("el-button",{attrs:{type:"info"},nativeOn:{click:function(t){return e.handleManagement(e.collectionInfo)}}},[e._v(" 任务配置 ")]),a("el-button",{nativeOn:{click:function(t){return e.startOpc(e.collectionInfo)}}},[e._v(" 任务下发 ")]),a("el-button",{attrs:{type:"warning"},nativeOn:{click:function(t){return e.saveHistorical(e.collectionInfo,e.thingcolumns,e.thingdata,!1)}}},[e._v(" 保存数据 ")]),a("el-button",{attrs:{type:"danger"},on:{click:function(t){e.visible=!1}}},[e._v(" 退出采集 ")])],1),a("div",{staticStyle:{margin:"40px auto",width:"90%"}},[a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{flex:"1","background-color":"#f1f3f4",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" 当前时间 ")]),a("div",{staticStyle:{flex:"2",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" "+e._s(e.nowTime)+" ")])]),a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{flex:"1","background-color":"#f1f3f4",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" 检测台体 ")]),a("div",{staticStyle:{flex:"2",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" "+e._s(e.collectionInfo.profile.testbed)+" ")])]),a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{flex:"1","background-color":"#f1f3f4",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" 检测任务 ")]),a("div",{staticStyle:{flex:"2",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[e._v(" "+e._s(e.collectionInfo.name)+" ")])])])])],1):e._e()],1),a("el-row",{attrs:{gutter:24}},[a("el-col",{staticStyle:{"margin-top":"20px"},attrs:{span:12}},[a("el-divider",[e._v("存储的数据")]),a("el-table",{key:e.historyEvidence.length,attrs:{border:"",data:e.historyEvidence,"max-height":.46*e.maxheight}},[a("el-table-column",{attrs:{align:"center",label:"序号","show-overflow-tooltip":"",width:"50"},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.$index;return[e._v(" "+e._s(a+1)+" ")]}}])}),e._l(e.historycolumns,(function(e,t){return a("el-table-column",{key:t,attrs:{align:"center",label:e.label,prop:e.prop,"show-overflow-tooltip":"",sortable:"",width:"auto"}})})),a("el-table-column",{attrs:{align:"center",label:"操作",width:"60"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row,i=t.$index;return[a("el-button",{staticClass:"el-icon-delete",attrs:{type:"text"},nativeOn:{click:function(t){return e.deleteHistory(n,i)}}})]}}])})],2)],1),a("el-col",{staticStyle:{"margin-top":"20px"},attrs:{span:12}},[a("el-divider",[e._v("其他数据")]),a("el-tabs",{on:{"tab-click":e.tabHandleClick},model:{value:e.activeName1,callback:function(t){e.activeName1=t},expression:"activeName1"}},[a("el-tab-pane",{attrs:{label:"实时数据",name:"first"}},[a("div",{staticClass:"thirdtb"},[a("el-row",{key:e.thirdtbKey},[a("real-card",{attrs:{height:.4*e.maxheight+"px",cardList:e.machinelist,avator:e.avator,fontsize:"20px"}})],1)],1)]),a("el-tab-pane",{attrs:{label:"图表",name:"second"}},[a("div",{directives:[{name:"infinite-scroll",rawName:"v-infinite-scroll",value:!0,expression:"true"}],style:{overflow:"auto",height:.4*e.maxheight+"px"}},[a("el-card",[a("el-image",{key:e.performancefilepath,attrs:{"preview-src-list":[e.$FileServe+e.performancefilepath],src:e.$FileServe+e.performancefilepath}}),a("div",{staticStyle:{margin:"40px auto",width:"90%"}},[a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{flex:"1","background-color":"#f1f3f4",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc",position:"relative"}},[a("div",{staticStyle:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}},[e._v(" 备注 ")])]),a("div",{staticStyle:{flex:"2",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[a("p",[e._v(" "+e._s(e.performanceremark1)+" ")]),a("p",[e._v(" "+e._s(e.performanceremark2)+" ")]),a("p",[e._v(" "+e._s(e.performanceremark3)+" ")])])])])],1),a("el-card",[a("el-image",{key:e.loadfilepath,attrs:{"preview-src-list":[e.$FileServe+e.loadfilepath],src:e.$FileServe+e.loadfilepath}}),a("div",{staticStyle:{margin:"40px auto",width:"90%"}},[a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{flex:"1","background-color":"#f1f3f4",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc",position:"relative"}},[a("div",{staticStyle:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}},[e._v(" 备注 ")])]),a("div",{staticStyle:{flex:"2",padding:"5px 10px","text-align":"center",border:"0.5px solid #ccc"}},[a("p",[e._v(" "+e._s(e.loadremark1)+" ")]),a("p",[e._v(" "+e._s(e.loadremark2)+" ")]),a("p",[e._v(" "+e._s(e.loadremark3)+" ")])])])])],1)],1)])],1)],1)],1)],1)]),a("el-dialog",{attrs:{"append-to-body":"","before-close":e.handleCloseAmis,center:"",top:"5vh",visible:e.management.dialog,width:"80%"},on:{"update:visible":function(t){return e.$set(e.management,"dialog",t)}}},[a("el-tabs",{model:{value:e.managementactiveName,callback:function(t){e.managementactiveName=t},expression:"managementactiveName"}},e._l(e.management.data,(function(e,t){return a("el-tab-pane",{key:t+"i",attrs:{label:e.title,name:t+""}},[a("amis",{attrs:{"modal-append-to-body":"",schema:e.data,"show-help":!1}})],1)})),1)],1)],1)},i=[],r=a("c7eb"),o=a("1da1"),c=(a("4de4"),a("d3b7"),a("caad"),a("2532"),a("e9c4"),a("ace4"),a("5cc6"),a("907a"),a("9a8c"),a("a975"),a("735e"),a("c1ac"),a("d139"),a("3a7b"),a("986a"),a("1d02"),a("d5d6"),a("82f8"),a("e91f"),a("60bd"),a("5f96"),a("3280"),a("3fcc"),a("ca91"),a("25a1"),a("cd26"),a("3c5d"),a("2954"),a("649e"),a("219c"),a("170b"),a("b39a"),a("1b3b"),a("3d71"),a("72f7"),a("c6e3"),a("b64b"),a("b0c0"),a("14d9"),a("159b"),a("a9e3"),a("99af"),a("a434"),a("e762")),s=a("a598"),l=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-container",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"topoEvidence",attrs:{"element-loading-background":"rgba(0, 0, 0, 0.8)","element-loading-spinner":"el-icon-loading"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.asideShow,expression:"asideShow"}],staticClass:"evidence_container_aside"},e._l(e.evidenceTopoList,(function(t,n){return a("div",{key:t.objectId,staticClass:"btns",class:e.currentTopoIndex==n?"success":"info",on:{click:function(a){return e.activeBtn(t,n)}}},[e._v(" "+e._s(n+1)+" ")])})),0),a("div",{staticClass:"evidence_main"},[a("div",{staticClass:"evidence_main_konva",attrs:{id:"evidencekonva"}}),e._l(e.evidenceList,(function(t,n){return a("div",{key:(new Date).getTime()+n,staticClass:"evidenceItem",style:{position:"absolute",top:t.success.evidence.attrs.y-5+"px",left:t.success.evidence.attrs.x-5+"px"}},[e._v(" "+e._s(t.count)+" ")])}))],2),e.deviceInfo.name?a("div",{staticClass:"evidence_footer"},[a("el-row",{attrs:{gutter:10}},[a("el-col",{attrs:{lg:3,md:2,sm:3,xl:1,xs:4}},[1==Number(e.query.step)?a("el-button",{attrs:{round:"",type:"success"},nativeOn:{click:function(t){return e.auditQuery(1,"review")}}},[e._v(" 预览审核 ")]):e._e(),3==Number(e.query.step)?a("el-button",{attrs:{round:"",type:"success"},nativeOn:{click:function(t){return e.auditQuery(1,"evidence")}}},[e._v(" 审核意见 ")]):e._e()],1),a("el-col",{attrs:{lg:16,md:13,sm:11,xl:18,xs:10}},[e.query.message&&4==Number(e.query.step)?a("el-link",{attrs:{type:"success",underline:!1}},[e._v(" 报告审核意见： "+e._s(e.query.message)+" ")]):e._e(),1==Number(e.query.step)||3==Number(e.query.step)?a("el-link",{attrs:{type:"danger",underline:!1}},[e._v(" "+e._s(e.deviceInfo.profile.message||"")+" ")]):e._e()],1),1!=Number(e.query.step)?a("el-col",{attrs:{lg:4,md:9,sm:10,xl:4,xs:10}},[a("el-badge",{attrs:{type:"warning",value:e.badge.Unreviewed.length},nativeOn:{click:function(t){return e.evidenceClick(e.badge.Unreviewed)}}},[a("el-button",{attrs:{circle:"",size:"mini",type:"warning"}},[e._v(" 未审核 ")])],1),a("el-badge",{attrs:{type:"primary",value:e.badge.Approved.length},nativeOn:{click:function(t){return e.evidenceClick(e.badge.Approved)}}},[a("el-button",{attrs:{circle:"",size:"mini",type:"primary"}},[e._v(" 审核通过 ")])],1),a("el-badge",{attrs:{type:"danger",value:e.badge.notapproved.length},nativeOn:{click:function(t){return e.evidenceClick(e.badge.notapproved)}}},[a("el-button",{attrs:{circle:"",size:"mini",type:"danger"}},[e._v(" 审核不过 ")])],1)],1):e._e()],1)],1):e._e(),a("div",{directives:[{name:"show",rawName:"v-show",value:e.asideShow,expression:"asideShow"}],staticClass:"evidence_list"},[a("el-table",{staticStyle:{width:"100%"},attrs:{"max-height":"700",data:e.evidenceList,stripe:"",border:""}},[a("el-table-column",{attrs:{fixed:"",prop:"date",label:"类别",width:"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-tag",{attrs:{type:"video"==t.row.type?"primary":"audio"==t.row.type?"success":"image"==t.row.type?"warning":"file"==t.row.type?"danger":"","disable-transitions":""}},[e._v(e._s(e.getType(t.row.type)))])]}}])}),a("el-table-column",{attrs:{prop:"count",label:"数量",width:"120"}}),a("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{directives:[{name:"show",rawName:"v-show",value:1==Number(e.query.step),expression:"Number(query.step) == 1"}],attrs:{title:"取证",type:"primary"},nativeOn:{click:function(a){return e.handleUpload(t.row)}}},[e._v(" 上传 ")]),a("el-button",{attrs:{type:"success"},nativeOn:{click:function(a){return e.handleEvidenceDetail(t.row)}}},[e._v("详情")])]}}])})],1)],1),a("el-drawer",{attrs:{"append-to-body":"",placement:"right",size:"50%",visible:e.auditDialog,"with-header":!1,"wrapper-closable":!0},on:{close:function(t){e.auditDialog=!1}}},[a("el-form",{ref:"form",attrs:{"label-width":"120px",model:e.deviceInfo}},["review"==e.taskType?a("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"0"}},[a("el-button",{attrs:{type:"primary"},on:{click:function(t){e.finishEvidence(e.deviceInfo,1==Number(e.query.step)?2:3)}}},[e._v(" 提交审核 ")])],1):e._e(),"evidence"==e.taskType?a("el-form-item",{staticStyle:{float:"","margin-top":"5px"},attrs:{"label-width":"0"}},[a("el-button",{on:{click:function(t){return e.notapproved(e.deviceInfo,-1)}}},[e._v(" 审核不过 ")]),a("el-button",{staticStyle:{"margin-left":"10px"},attrs:{type:"primary"},on:{click:function(t){return e.notapproved(e.deviceInfo,3)}}},[e._v(" 审核通过 ")])],1):e._e(),1!=Number(e.query.step)?a("el-form-item",{attrs:{label:"报告审核意见"}},[a("el-input",{staticStyle:{width:"60%"},attrs:{rows:2,type:"textarea"},model:{value:e.deviceInfo.profile.message,callback:function(t){e.$set(e.deviceInfo.profile,"message",t)},expression:"deviceInfo.profile.message"}})],1):e._e()],1),a("span",[a("el-table",{attrs:{border:"",data:e.auditList,size:"mini",stripe:""}},[a("el-table-column",{attrs:{align:"center",label:"序号",prop:"original.path","show-overflow-tooltip":"",width:"80"},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.$index;return[e._v(" "+e._s(a+1)+" ")]}}])}),a("el-table-column",{attrs:{align:"center",label:"证据",prop:"row.original.path","show-overflow-tooltip":"",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-link",{attrs:{href:e.$FileServe+n.original.path,target:"_blank"}},[e._v(" "+e._s(n.original.path.split("/")[""+(n.original.path.split("/").length-1)])+" ")])]}}])}),a("el-table-column",{attrs:{align:"center",label:"类型",prop:"row.original.type","show-overflow-tooltip":"",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-tag",{attrs:{effect:"plain"}},[e._v(" "+e._s(e.getType(n.original.type))+" ")])]}}])}),a("el-table-column",{attrs:{align:"center",label:"备注",prop:"row.original.remarks",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-input",{attrs:{readonly:Number(e.query.step)>2,rows:2,type:"textarea"},model:{value:n.original.remarks,callback:function(t){e.$set(n.original,"remarks",t)},expression:"row.original.remarks"}})]}}])}),1==Number(e.query.step)?a("el-table-column",{attrs:{align:"center",label:1==Number(e.query.step)?"操作":"单项审核",width:1==Number(e.query.step)?"220":"420"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row,i=t.$index;return[a("el-button",{attrs:{sizes:"mini",type:"danger"},nativeOn:{click:function(t){return e.deleteFile(n.objectId,i,e.evidences)}}},[e._v(" 删除 ")]),a("el-button",{attrs:{sizes:"mini",type:"success"},nativeOn:{click:function(t){return e.saveEvidences(n.objectId,i,n)}}},[e._v(" 保存 ")])]}}],null,!1,3054188905)}):e._e(),"review"!=e.taskType?a("el-table-column",{attrs:{align:"center",label:"当前状态",prop:"original.status",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-tag",{attrs:{effect:"dark",type:["success","info","danger"]["未审核"==n.original.status?1:"通过审核"==n.original.status?0:2]}},[e._v(" "+e._s(n.original.status)+" ")])]}}],null,!1,3424704454)}):e._e(),"review"!=e.taskType?a("el-table-column",{attrs:{align:"center",fixed:"right",label:"质检项审核意见",prop:"original.message","show-overflow-tooltip":""},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-input",{attrs:{rows:2,type:"textarea"},model:{value:n.original.message,callback:function(t){e.$set(n.original,"message",t)},expression:"row.original.message"}})]}}],null,!1,2712488978)}):e._e()],1)],1)],1),a("el-drawer",{attrs:{"append-to-body":"",size:"60%",visible:e.evidenceDialog,"with-header":!1,"wrapper-closable":!1},on:{close:function(t){e.evidenceDialog=!1}}},[a("div",[a("el-form",{staticStyle:{margin:"10px 20px"}},[a("div",{staticStyle:{display:"flex","justify-content":"space-between"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:1==Number(e.query.step),expression:"Number(query.step) == 1"}]},[a("el-button",{attrs:{title:"取证",type:"primary"},nativeOn:{click:function(t){return e.handleUpload1()}}},[e._v(" 上传 ")])],1),a("el-button",{attrs:{title:"关闭",type:"info"},nativeOn:{click:function(t){return e.clouseDraw(t)}}},[e._v(" 关闭 ")])],1)])],1),a("el-table",{attrs:{border:"",data:e.evidences,stripe:""}},[a("el-table-column",{attrs:{align:"center",label:"序号","show-overflow-tooltip":"",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.$index;return[e._v(" "+e._s(a+1)+" ")]}}])}),a("el-table-column",{attrs:{align:"center",label:"证据",prop:"row.original.path","show-overflow-tooltip":"",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-link",{attrs:{href:e.$FileServe+n.original.path,target:"_blank"}},[e._v(" "+e._s(n.original.path.split("/")[""+(n.original.path.split("/").length-1)])+" ")])]}}])}),a("el-table-column",{attrs:{align:"center",label:"备注",prop:"row.original.remarks",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-input",{attrs:{rows:2,type:"textarea"},model:{value:n.original.remarks,callback:function(t){e.$set(n.original,"remarks",t)},expression:"row.original.remarks"}})]}}])}),a("el-table-column",{attrs:{align:"center",label:"类型",prop:"row.original.type","show-overflow-tooltip":"",sortable:"",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-tag",{attrs:{effect:"plain"}},[e._v(" "+e._s(e.getType(n.original.type))+" ")])]}}])}),a("el-table-column",{attrs:{align:"center",label:1==Number(e.query.step)?"操作":"单项审核",width:1==Number(e.query.step)?"220":"420"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row,i=t.$index;return[1==Number(e.query.step)?a("el-button",{attrs:{sizes:"mini",type:"danger"},nativeOn:{click:function(t){return e.deleteFile(n.objectId,i,e.evidences)}}},[e._v(" 删除 ")]):e._e(),1==Number(e.query.step)?a("el-button",{attrs:{sizes:"mini",type:"success"},nativeOn:{click:function(t){return e.saveEvidences(n.objectId,i,n)}}},[e._v(" 保存 ")]):e._e(),1!==Number(e.query.step)&&4!=Number(e.query.step)?a("el-radio-group",{attrs:{size:"mini"},model:{value:n.original.status,callback:function(t){e.$set(n.original,"status",t)},expression:"row.original.status"}},[a("el-radio",{attrs:{label:"未审核"}},[e._v(" 未审核 ")]),a("el-radio",{attrs:{label:"通过审核"}},[e._v(" 审核通过 ")]),a("el-radio",{attrs:{label:"审核不通过"}},[e._v(" 审核不通过 ")])],1):e._e(),1!==Number(e.query.step)&&3!=Number(e.query.step)?a("el-tag",{attrs:{effect:"dark",type:["","success","danger"][["未审核","通过审核","不通过审核"].indexOf(n.original.status)]}},[e._v(" "+e._s(n.original.status)+" ")]):e._e()]}}])}),3==Number(e.query.step)?a("el-table-column",{attrs:{align:"center",label:"质检项审核意见",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-input",{attrs:{size:"mini",type:"textarea"},model:{value:n.original.message,callback:function(t){e.$set(n.original,"message",t)},expression:"row.original.message"}})]}}],null,!1,102253983)}):e._e(),3==Number(e.query.step)?a("el-table-column",{attrs:{align:"center",label:"提交",width:"auto"},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.row;return[a("el-button",{attrs:{plain:""},nativeOn:{click:function(t){return e.changeItem(n)}}},[e._v(" 提交 ")])]}}],null,!1,2728491722)}):e._e()],1)],1),a("input",{ref:"uploader",staticStyle:{display:"none"},attrs:{accept:"*",type:"file"},on:{change:function(t){return e.doUpload(t)}}})],1)},d=[],u=(a("25f0"),a("7db0"),a("5c96")),p=a("8ba7"),f=a("b775");function v(e){return Object(f["a"])({url:"/classes/Evidence",method:"get",params:e})}function h(e){return Object(f["a"])({url:"/batch",method:"post",data:e})}function m(e,t){return b.apply(this,arguments)}function b(){return b=Object(o["a"])(Object(r["a"])().mark((function e(t,a){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/evidence?id=".concat(t),method:"post",data:a}));case 1:case"end":return e.stop()}}),e)}))),b.apply(this,arguments)}function g(e){return y.apply(this,arguments)}function y(){return y=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/generatereport?id=".concat(t),method:"post"}));case 1:case"end":return e.stop()}}),e)}))),y.apply(this,arguments)}function w(e){return x.apply(this,arguments)}function x(){return x=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/classes/Evidence/".concat(t),method:"delete"}));case 1:case"end":return e.stop()}}),e)}))),x.apply(this,arguments)}function k(e,t){return j.apply(this,arguments)}function j(){return j=Object(o["a"])(Object(r["a"])().mark((function e(t,a){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/classes/Evidence/".concat(t),method:"put",data:a}));case 1:case"end":return e.stop()}}),e)}))),j.apply(this,arguments)}function O(e){return I.apply(this,arguments)}function I(){return I=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/drawxnqx",method:"post",data:t}));case 1:case"end":return e.stop()}}),e)}))),I.apply(this,arguments)}var S=a("1285"),T=a("bc3a"),$=a.n(T);function C(e,t){return E.apply(this,arguments)}function E(){return E=Object(o["a"])(Object(r["a"])().mark((function e(t,a){var n,i=arguments;return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=i.length>2&&void 0!==i[2]?i[2]:{Accept:"application/json","Content-Type":"application/json; charset=utf-8"},e.abrupt("return",$.a.post(t,a,n));case 2:case"end":return e.stop()}}),e)}))),E.apply(this,arguments)}var D=a("5f87"),N={name:"TopoEvicence",props:{deviceInfo:{type:Object,default:function(){}},cardList:{type:Array,default:function(){return[]}},asideShow:{type:Boolean,default:function(){return!0}},objectId:{type:String},avator:{type:String},query:{type:Object,default:function(){}}},data:function(){return{loading:!0,ukey:"",evidenceTopoList:[],currentTopoIndex:0,currentTopo:{},devicelayer:{},devicestage:{},evidenceList:[],selectType:{},evidenceCountShow:!0,timer:"",evidenceid:"",requests:{},evidence:{},evidenceDialog:!1,evidences:[],auditDialog:!1,auditList:[],taskType:"",badge:{Unreviewed:[],Approved:[],notapproved:[]}}},mounted:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a={order:"title",skip:0,where:{type:"topo",class:"Device",key:e.deviceInfo.objectId}},t.next=3,e.getUkey(e.deviceInfo.parentId.objectId);case 3:return t.next=5,Object(p["d"])(a);case 5:n=t.sent,i=n.results,e.loading=!1,e.evidenceTopoList=i,e.currentTopo=e.evidenceTopoList[e.currentTopoIndex],e.createKonva(),e.initKonva(),1!=e.query.step&&e.auditQuery(2,"review");case 13:case"end":return t.stop()}}),t)})))()},methods:{evidenceClick:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:t.evidences=[];try{t.evidences=e,t.evidenceDialog=!0}catch(n){console.log(n)}case 2:case"end":return a.stop()}}),a)})))()},changeItem:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,n={original:_.merge(e.original,{status:e.original.status,message:e.original.message})},a.next=4,k(e.objectId,n);case 4:i=a.sent,console.log(i),t.auditQuery(0,"init"),t.$message({type:"success",message:"提交成功",showClose:!0}),a.next=14;break;case 10:a.prev=10,a.t0=a["catch"](0),console.log(a.t0),t.$baseMessage(t.$translateTitle("alert.Data request error")+"".concat(a.t0),"error","dgiot-hey-message-error");case 14:case"end":return a.stop()}}),a,null,[[0,10]])})))()},notapproved:function(e,t){var a=this;return Object(o["a"])(Object(r["a"])().mark((function n(){var i;return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(a.badge.Unreviewed.length!==a.auditList){n.next=3;break}return a.$message("当前任务证据没有被审核"),n.abrupt("return",!1);case 3:return n.prev=3,i={profile:_.merge(e.profile,{message:e.profile.message,step:t,endtime:(new Date).getTime().toString()})},n.next=7,Object(S["d"])(e.objectId,i);case 7:n.sent,a.auditDialog=!1,n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](3),a.$message(n.t0);case 14:case"end":return n.stop()}}),n,null,[[3,11]])})))()},finishEvidence:function(e,t){var a=this;return Object(o["a"])(Object(r["a"])().mark((function n(){return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:a.$confirm("请确认是否提交?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(Object(o["a"])(Object(r["a"])().mark((function n(){var i,o,c;return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(i=u["Loading"].service({fullscreen:!0}),n.prev=1,null===(o=a.auditList)||void 0===o||!o.length){n.next=13;break}return c={profile:_.merge(e.profile,{step:t})},n.next=6,g(e.objectId);case 6:return n.next=8,Object(S["d"])(e.objectId,c);case 8:n.sent,i.close(),a.$emit("reloadCurrent"),n.next=15;break;case 13:return a.$message({type:"info",message:"未提交任何证据"}),n.abrupt("return");case 15:n.next=21;break;case 17:n.prev=17,n.t0=n["catch"](1),i.close(),a.$message({type:"error",message:n.t0});case 21:case"end":return n.stop()}}),n,null,[[1,17]])})))).catch((function(){a.$message({type:"info",message:"已取消"})}));case 1:case"end":return n.stop()}}),n)})))()},auditQuery:function(e,t){var a=this;return Object(o["a"])(Object(r["a"])().mark((function n(){var i,o,c;return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a.taskType=t,a.badge={Unreviewed:[],Approved:[],notapproved:[]},n.prev=2,i={order:"-createdAt",skip:0,where:{"original.taskid":a.deviceInfo.objectId,reportId:{$ne:a.deviceInfo.objectId}}},1==e&&(a.auditDialog=!0),n.next=7,v(i);case 7:o=n.sent,c=o.results,a.auditList=_.filter(c,(function(e){return"avgs"!==e.original.type})),a.auditList.forEach((function(e){"未审核"==e.original.status?a.badge.Unreviewed.push(e):"通过审核"==e.original.status?a.badge.Approved.push(e):a.badge.notapproved.push(e)})),n.next=16;break;case 13:n.prev=13,n.t0=n["catch"](2),a.$message({message:n.t0,type:"danger"});case 16:case"end":return n.stop()}}),n,null,[[2,13]])})))()},clouseDraw:function(){this.evidenceDialog=!1,this.auditDialog=!1},deleteFile:function(e,t,a){var n=this;return Object(o["a"])(Object(r["a"])().mark((function i(){var o;return Object(r["a"])().wrap((function(i){while(1)switch(i.prev=i.next){case 0:return a.splice(t,1),i.prev=1,o=u["Loading"].service({fullscreen:!0}),i.next=5,w(e);case 5:i.sent,n.queryEvidence(n.requests),n.evidenceDialog&&n.handleEvidenceDetail(n.selectType),o.close(),n.$message({message:"删除成功",type:"success"}),i.next=15;break;case 12:i.prev=12,i.t0=i["catch"](1),n.$message({message:i.t0,type:"danger"});case 15:case"end":return i.stop()}}),i,null,[[1,12]])})))()},saveEvidences:function(e,t,a){var n=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var i,o;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,i=u["Loading"].service({fullscreen:!0}),o={original:a.original},t.next=5,k(e,o);case 5:t.sent,i.close(),n.$message({message:"保存成功",type:"success"}),t.next=13;break;case 10:t.prev=10,t.t0=t["catch"](0),n.$message({message:t.t0,type:"danger"});case 13:case"end":return t.stop()}}),t,null,[[0,10]])})))()},handleEvidenceDetail:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.selectType=e,console.log(e,t.selectType),n={order:"-createdAt",skip:0,where:{reportId:t.currentTopo.objectId,"original.controlid":e.success.evidence.attrs.id}},a.next=5,v(n);case 5:i=a.sent,o=i.results,c=void 0===o?[]:o,console.log(c),t.evidences=c,t.evidenceDialog=!0;case 11:case"end":return a.stop()}}),a)})))()},handleUpload1:function(){this.$refs.uploader.click()},doUpload:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s,l,d,u;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:for(s in t.timer=new Date,t.evidenceid=t.$md5("Evidence"+t.ukey+Math.round(t.timer)).substring(0,10),console.log(t.evidenceid,t.timer),n=e.target.files[0],i=n.name.substring(n.name.lastIndexOf(".")),a.prev=5,o={auth_token:Object(D["a"])(),scene:"evidence",code:"",path:"dgiot_file/evidence/".concat(t.selectType.type),output:"json",submit:"upload",file:n,filename:"".concat(t.evidenceid).concat(i)},c=new FormData,o)c.append(s,o[s]);return l=t.$FileServe+"/upload",a.next=12,C(l,c);case 12:d=a.sent,u=d.data,null!==u&&void 0!==u&&u.md5&&t.depositEvidence(u),a.next=19;break;case 17:a.prev=17,a.t0=a["catch"](5);case 19:case"end":return a.stop()}}),a,null,[[5,17]])})))()},depositEvidence:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,n={objectId:t.evidenceid,ukey:t.ukey,timestamp:Math.round(t.timer),md5:e.md5,original:{taskid:t.deviceInfo.objectId,controlid:t.selectType.id,path:e.path,type:t.selectType.type}},console.log(n,t.currentTopo),a.next=5,m(t.currentTopo.objectId,n);case 5:a.sent,a.next=11;break;case 8:a.prev=8,a.t0=a["catch"](0),console.log(a.t0);case 11:t.queryEvidence(t.requests),t.evidenceDialog&&t.handleEvidenceDetail(t.selectType);case 13:case"end":return a.stop()}}),a,null,[[0,8]])})))()},handleUpload:function(e){console.log(e),this.selectType=e,this.$refs.uploader.click()},getType:function(e){switch(e){case"video":return"视频";case"audio":return"音频";case"image":return"图片";case"file":return"文件"}},createKonva:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.devicelayer=Konva.Node.create(e.currentTopo.data.konva.Stage,"evidencekonva").findOne("Layer"),e.devicestage=new Konva.Stage({container:"evidencekonva",width:e.currentTopo.data.konva.Stage.attrs.width,height:e.currentTopo.data.konva.Stage.attrs.height}),e.devicestage.add(e.devicelayer);case 3:case"end":return t.stop()}}),t)})))()},activeBtn:function(e,t){this.evidenceList=[],console.log(e,t),this.currentTopoIndex=t,this.currentTopo=this.evidenceTopoList[this.currentTopoIndex],this.createKonva(),this.initKonva()},initKonva:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.devicestage.find("Label").forEach((function(e){e.setAttrs({draggable:!1})})),e.devicestage.find("Text").forEach((function(e){e.setAttrs({draggable:!1}),e.on("touchend",function(){var e=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("click",function(){var e=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())})),a=[],e.devicestage.find("Path").forEach((function(t){t.setAttrs({draggable:!1}),a.push(t),t.on("touchend",function(){var a=Object(o["a"])(Object(r["a"])().mark((function a(n){var i,o,c,s,l;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return console.log("1111",t),i={},e.evidenceList.forEach((function(e){t.attrs.id==e.success.evidence.attrs.id&&(i=e)})),e.selectType=i,console.log(i,e.selectType),o={order:"-createdAt",skip:0,where:{reportId:e.currentTopo.objectId,"original.controlid":i.success.evidence.attrs.id}},a.next=8,v(o);case 8:c=a.sent,s=c.results,l=void 0===s?[]:s,console.log(l),e.evidences=l,e.evidenceDialog=!0;case 14:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}()),t.on("click",function(){var a=Object(o["a"])(Object(r["a"])().mark((function a(n){var i,o,c,s,l;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return console.log("1111",t),i={},e.evidenceList.forEach((function(e){t.attrs.id==e.success.evidence.attrs.id&&(i=e)})),e.selectType=i,console.log(i,e.selectType),o={order:"-createdAt",skip:0,where:{reportId:e.currentTopo.objectId,"original.controlid":i.success.evidence.attrs.id}},a.next=8,v(o);case 8:c=a.sent,s=c.results,l=void 0===s?[]:s,console.log(l),e.evidences=l,e.evidenceDialog=!0;case 14:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}())})),e.devicestage.find("Image").forEach((function(t){t.setAttrs({draggable:!1});var a=new Image;t.setAttrs({image:a}),a.src=t.attrs.src.includes("//")?t.attrs.src:e.$FileServe+t.attrs.src})),e.devicestage.find("Rect").forEach((function(e){e.setAttrs({draggable:!1})})),e.devicelayer.batchDraw(),setTimeout((function(){e.devicelayer.batchDraw()}),500),e.queryBatch(a);case 9:case"end":return t.stop()}}),t)})))()},queryBatch:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:n={batch:[],path:[]},e.forEach((function(e){n.batch.push({body:{order:"-createdAt",skip:0,count:"objectId",where:{reportId:t.currentTopo.objectId,"original.controlid":e.attrs.id}},method:"GET",evidence:e.attrs.icon,path:"/classes/Evidence"}),n.path.push(e)})),t.evidence=n,t.requests={requests:n.batch},t.queryEvidence(t.requests);case 5:case"end":return a.stop()}}),a)})))()},queryEvidence:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,h(e);case 2:n=a.sent,n.forEach((function(e,a){e.success.evidence=t.evidence.path[a],e.count=e.success.count,e.type=e.success.evidence.attrs.type,e.id=e.success.evidence.attrs.id})),t.evidenceList=n;case 5:case"end":return a.stop()}}),a)})))()},getUkey:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.ukey="",a.prev=1,i={limit:1,order:"-createdAt",skip:0,keys:"devaddr",where:{parentId:e,product:"3f95880e09"}},a.next=5,Object(S["e"])(i);case 5:o=a.sent,c=o.results,s=void 0===c?[]:c,null!==s&&void 0!==s&&null!==(n=s[0])&&void 0!==n&&n.devaddr&&(t.ukey=s[0].devaddr,console.log("this.ukey",t.ukey)),a.next=14;break;case 11:a.prev=11,a.t0=a["catch"](1),console.log("错误",a.t0);case 14:case"end":return a.stop()}}),a,null,[[1,11]])})))()}}},B=N,A=(a("425e"),a("2877")),q=Object(A["a"])(B,l,d,!1,null,"59ae6daa",null),L=q.exports,F=a("9f28"),M=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"topo_content",on:{mouseenter:e.enter,mouseleave:e.leave}},[a("div",{attrs:{id:"screenTopo"}}),e.vueFlag?a("div",e._l(e.vueComponents,(function(t,n){return a("div",{key:n,staticClass:"vue_component",style:{left:t.x+"px",top:t.y+"px",width:t.width+"px",height:t.height+"px"}},["counter"==t.type&&"all_countervalue"!=t.id?a("topo-card",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"count"==t.type&&"all_countvalue"==t.id?a("screen-headcounter",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"count"==t.type?a("screen-headitem",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"liveboard"==t.type?a("dgiot-aliplayer",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"line"==t.type?a("screen-line",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t,viewtype:e.viewtype}}):"devicebar"==t.type?a("screen-device-bar",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t,viewtype:e.viewtype}}):"list"==t.type&&"device_list"==t.id?a("screen-device",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t},on:{initScreen:e.initScreen}}):"list"==t.type&&"warning_list"==t.id?a("topo-caltable",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"list"==t.type&&"warning_list1"==t.id?a("dgiot-notification1",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"map"==t.type&&"baidumap"==t.id?a("screen-baidumap",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t},on:{initScreen:e.initScreen}}):"map"==t.type&&"sgmap"==t.id?a("screen-sgmap",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t},on:{initScreen:e.initScreen}}):"list"==t.type&&"workorder_list"==t.id?a("work-order",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"pie"==t.type?a("topo-pie",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"realtime"==t.type?a("real-time",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"3d"==t.type&&"3d_fbx"==t.id?a("dgiot-model-fac",{style:{width:t.width+"px",height:t.height+"px"},attrs:{comp:t}}):"konvaimage"==t.type?a("img",{style:{width:t.width+"px",height:t.height+"px"},attrs:{src:t.src.includes("//")?t.src:e.$FileServe+t.src}}):e._e()],1)})),0):e._e(),e.amisFlag?a("div",e._l(e.amisComponents,(function(e,t){return a("amis",{key:t,staticClass:"amis_component",style:{left:e.x+"px",top:e.y+"px",width:e.width+"px",height:e.height+"px"},attrs:{"modal-append-to-body":"",schema:e.viewData,"show-help":!1}})})),1):e._e(),e.dialogTopoAmisVisible?a("el-dialog",{attrs:{top:"10vh","append-to-body":!0,width:"1240px",visible:e.dialogTopoAmisVisible},on:{"update:visible":function(t){e.dialogTopoAmisVisible=t},close:e.handlecloseDevice}},[a("amis",{attrs:{"modal-append-to-body":"",schema:e.topoAmisData,"show-help":!1}})],1):e._e()],1)},z=[],P=(a("a4d3"),a("e01a"),a("d28b"),a("3ca3"),a("ddb0"),a("d9e2"),a("06c5"));function V(e,t){var a="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=Object(P["a"])(e))||t&&e&&"number"===typeof e.length){a&&(e=a);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,c=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){c=!0,r=e},f:function(){try{o||null==a["return"]||a["return"]()}finally{if(c)throw r}}}}var K=a("264a"),H=a("aa38"),U=a("32db"),R=a("c7d9"),J=a("ae53"),W=a("fca4"),Q=a("ad0f"),G=a("e6a3"),Z=a("a458"),Y=a("c006"),X=a("11ac"),ee=a("766c"),te=a("b34f"),ae=a("624b"),ne=a("39c4"),ie=a("ed08"),re={name:"TopoDevice",components:{TopoPie:U["a"],TopoCard:H["a"],DgiotAliplayer:K["a"],TopoCaltable:R["a"],ScreenDevice:J["a"],WorkOrder:W["a"],ScreenRealcard:Q["a"],ScreenHeaditem:Y["a"],ScreenBaidumap:X["a"],ScreenSgmap:ee["a"],Amis:s["a"],ScreenLine:G["a"],ScreenDeviceBar:Z["a"],RealTime:te["a"],DgiotNotification1:ae["a"]},props:{viewInfo:{type:Object,default:function(){}}},data:function(){return{vueFlag:!1,amisFlag:!1,viewtype:"Dashboard",json:{},layer:{},stage:{},vueComponents:[],dialogTopoAmisVisible:!1,topoAmisData:{},width:1200,height:700,dashboardId:"",konvatimer:null}},mounted:function(){var e,t=this;this.isPC=Object(ie["b"])(),this.vueComponents=[],this.amisComponents=[],console.log("查看konva",this.viewInfo),this.dashboardId=this.viewInfo.objectId;var a=document.querySelector(".dialog_wrap");console.log(a.offsetWidth,a.offsetHeight),this.width=a.offsetWidth,this.height=a.offsetHeight;var n=new ResizeObserver((function(e){var a,n=V(e);try{var i=function(){var e=a.value;e.target.offsetWidth!=t.width&&(null!==t.konvatimer&&clearTimeout(t.konvatimer),t.konvatimer=setTimeout((function(){console.log("变化",e.target.offsetWidth),t.width=e.target.offsetWidth,t.height=e.target.offsetHeight,t.layer=Konva.Node.create(t.json,"screenTopo").findOne("Layer"),t.stage=new Konva.Stage({container:"screenTopo",width:t.width,height:t.height}),t.stage.add(t.layer),t.handleInitKonva()}),100))};for(n.s();!(a=n.n()).done;)i()}catch(r){n.e(r)}finally{n.f()}}));n.observe(document.querySelector(".dialog_wrap")),this.json=null===(e=this.viewInfo.data)||void 0===e||null===(e=e.konva)||void 0===e?void 0:e.Stage,this.layer=Konva.Node.create(this.json,"screenTopo").findOne("Layer"),this.stage=new Konva.Stage({container:"screenTopo",width:this.width,height:this.height}),this.stage.add(this.layer),this.$dgiotBus.$off("$dg/user/allrealdata"),this.$dgiotBus.$on("$dg/user/allrealdata",(function(e){var a=String.fromCharCode.apply(null,new Uint8Array(e)),n=JSON.parse(c["a"].decode(a));console.log("组态大屏 ",n);var i=0,r=0,o=0;n.forEach((function(e){var a=e.number+e.unit,n="green";e.hasOwnProperty("color")&&(n=e.color,"red"===e.color||"green"===e.color||e.color);t.putNode(t.stage,e.lable,a,n)})),t.putNode(t.stage,"status_red_text",i.toString(),"red"),t.putNode(t.stage,"status_green_text",r.toString(),"green"),t.putNode(t.stage,"status_yellow_text",o.toString(),"yellow")})),this.handleInitKonva()},methods:{initScreen:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e.dashboardId,t.next=3,Object(ne["a"])(a,{});case 3:case"end":return t.stop()}}),t)})))()},handleInitKonva:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i,o,c;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.clientWidth=document.body.clientWidth,e.clientWidth>500&&(a=document.getElementsByTagName("html")[0],a.style.fontSize=document.body.clientWidth/1940*16+"px"),n=[],i=[],e.amisFlag=!1,e.stage.find("Label").forEach((function(t){e.initSize(t),t.setAttrs({draggable:!1})})),e.stage.find("Tag").forEach((function(t){t.setAttrs({draggable:!1}),t=e.initScale(t)})),e.stage.find("Text").forEach((function(t){t.setAttrs({draggable:!1}),t=e.initScale(t)})),e.stage.find("Image").forEach((function(t){if(e.initSize(t),"bg"==t.attrs.id){var a=new Image;t.setAttrs({image:a}),a.src=t.attrs.src.includes("//")?t.attrs.src:e.$FileServe+t.attrs.src}if("konvaimage"==t.attrs.type||"vuecomponent"==t.attrs.name){var r=t.attrs;n.push(r)}else if("amiscomponent"==t.attrs.name){var o=t.attrs;i.push(o)}else if(t.attrs.id.indexOf("不")<0&&t.attrs.id.indexOf("bg")<0){var c=new Image;t.setAttrs({image:c}),c.src=t.attrs.src.includes("//")?t.attrs.src:e.$FileServe+t.attrs.src}})),e.stage.find("Rect").forEach((function(t){if(e.initSize(t),"vuecomponent"==t.attrs.name){var a=t.attrs;n.push(a)}else if("amiscomponent"==t.attrs.name){var r=t.attrs;i.push(r)}})),e.layer.batchDraw(),setTimeout((function(){e.layer.batchDraw()}),1500),e.vueComponents=n,e.vueFlag=!0,e.amisComponents=i,o=0;case 16:if(!(o<e.amisComponents.length)){t.next=24;break}return t.next=19,Object(p["b"])(e.amisComponents[o].id);case 19:c=t.sent,e.amisComponents[o].viewData=c.data.data;case 21:o++,t.next=16;break;case 24:e.amisFlag=!0;case 25:case"end":return t.stop()}}),t)})))()},initSize:function(e){var t=this.width/1900,a=this.height/940;e.setAttrs({draggable:!1,x:e.attrs.x*t,y:e.attrs.y*a,width:e.attrs.width*t,height:e.attrs.height*a,fontSize:e.attrs.fontSize*t})},initScale:function(e){var t=this.width/1900,a=this.height/940;return e.attrs.fontSize=e.attrs.fontSize*t,e.attrs.x=e.attrs.x*t,e.attrs.width=e.attrs.width*t,e.attrs.y=e.attrs.y*a,e.attrs.height=e.attrs.height*a,e},enter:function(){window.addEventListener("mousewheel",this.handleScroll,!0)},leave:function(){window.removeEventListener("mousewheel",this.handleScroll,!0)},handleScroll:function(e){e=e||window.event;document.querySelector(".topo_content")},putNode:function(e,t,a,n){e.find("#".concat(t)).forEach((function(e){e.setAttr("text",a)}));var i="#".concat(t)+"_tag";e.find(i).forEach((function(e){e.setAttr("fill",n)})),this.layer.batchDraw()}}},oe=re,ce=(a("3304"),Object(A["a"])(oe,M,z,!1,null,"08229d5e",null)),se=ce.exports,le=a("90be"),de=a("59d7"),ue=a.n(de);function pe(e){return fe.apply(this,arguments)}function fe(){return fe=Object(o["a"])(Object(r["a"])().mark((function e(t){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f["a"])({url:"/head",method:"post",headers:{accept:"application/json","Content-Type":"application/json"},data:t}));case 1:case"end":return e.stop()}}),e)}))),fe.apply(this,arguments)}var ve={name:"AmisPage",props:{},components:{amis:s["a"],TopoEvicence:L,TopoDevice:F["a"],TopoScreen:se,RealCard:le["a"]},filters:{filterVal:function(e){return e||0==e?e:"--"}},data:function(){return{commandInfo:{dialog:!1},viewInfo:{},showType:"",dialog:!1,loading:!0,viewData:{},dialogEvidenceVisible:!1,receiceEvidence:{},query:{},asideShow:!0,dialogTopoVisible:!1,deviceInfo:{},reportInfo:{},reportDialog:!1,officeapps:"",management:{dialog:!1,data:{}},managementactiveName:"0",avator:ue.a,machinelist:[],timer:"",nowTime:"",activeName1:"first",thirdtbKey:(new Date).getTime(),collectionInfo:{},drawxnqxPath:"",profiledrawxnqxPath:"",thingdata:[],realtimedata:[],thingcolumns:[],historycolumns:[],historydata:[],historyEvidence:[],historyEvidenceid:"",visible:!1,maxheight:"480",loadfilepath:"",drawdata:{},performancefilepath:"",loadremark1:"",loadremark2:"",loadremark3:"",performanceremark1:"",performanceremark2:"",performanceremark3:""}},computed:{dragOptions:function(){return{animation:600,group:"description"}},finallyColumns:function(){var e=this;return this.columns.filter((function(t){return e.checkList.includes(t.label)}))}},watch:{},created:function(){return Object(o["a"])(Object(r["a"])().mark((function e(){return Object(r["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},mounted:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=location.hash.split("/")[location.hash.split("/").length-1],localStorage.setItem("currentViewId",a),t.prev=2,t.next=5,Object(p["b"])(a);case 5:n=t.sent,e.viewInfo=n.data||{},e.viewData=n.data.data||{},console.log("res.class",n),e.showType=n.data.flag,i=localStorage.getItem("classtype")||"",i!=n.class&&(localStorage.setItem("classtype",n.class),e.$dgiotBus.$emit("reloadroletree")),"{}"!=JSON.stringify(e.viewData)?(e.dialog=!0,e.loading=!1):(e.$message("未找到该低代码模板"),e.loading=!1),t.next=19;break;case 15:t.prev=15,t.t0=t["catch"](2),e.$message("未找到该低代码模板"),e.loading=!1;case 19:e.$dgiotBus.$off("review/report"),e.$dgiotBus.$on("review/report",(function(t){var a=e.$FileServe+t.profile.docx;e.reportInfo=t,e.reportDialog=!0,e.officeapps="https://view.officeapps.live.com/op/view.aspx?src="+a})),e.$dgiotBus.$off("review/deviceTopo"),e.$dgiotBus.$on("review/deviceTopo",(function(t){e.deviceInfo=t,e.dialogTopoVisible=!0})),e.$dgiotBus.$off("collect/evidence"),e.$dgiotBus.$on("collect/evidence",(function(t){var a,n,i;e.receiceEvidence=t,t.profile.step=-1==t.profile.step?1:2==t.profile.step?3:t.profile.step;var r={taskid:t.objectId,suite:0,state:"preview",step:null===(a=t.profile)||void 0===a?void 0:a.step,back:null===(n=t.profile)||void 0===n?void 0:n.step,message:null===(i=t.profile)||void 0===i?void 0:i.message};console.log("接收的证据消息",t,r),e.query=r,e.dialogEvidenceVisible=!0})),e.$dgiotBus.$off("collect/realdata"),e.$dgiotBus.$on("collect/realdata",(function(t){e.visibleInfo(t),e.maxheight=document.body.clientHeight,console.log(e.maxheight),e.timer=setInterval((function(){e.datetime()}),1e3)})),e.$dgiotBus.$off("$dg/user/devicestate"),e.$dgiotBus.$on("$dg/user/devicestate",(function(e){var t=String.fromCharCode.apply(null,new Uint8Array(e));console.log("解码接收消息",t);var a={},n=JSON.parse(t);if(n){var i=Object.keys(n);a.key=i[0],a.parseString=n[i[0]];var r=0,o=a.key;if(document.getElementsByClassName("dgiotobjectId").length>0){for(var c=1;c<document.getElementsByClassName("dgiotobjectId").length-1;c++){var s=document.getElementsByClassName("dgiotobjectId")[c].getElementsByClassName("antd-PlainField")[0].innerHTML;if(s==o){r=c;break}}document.getElementsByClassName("dgiotaddress")[r].getElementsByClassName("antd-PlainField")[0].innerHTML=a.parseString.address;var l=document.getElementsByClassName("dgiotstatus")[r].getElementsByClassName("label")[0].parentNode;"ONLINE"==a.parseString.status?l.innerHTML="<span class='label label-success'>在线</span>":"OFFLINE"==a.parseString.status&&(l.innerHTML="<span class='label label-danger'>离线</span>")}}}));case 29:case"end":return t.stop()}}),t,null,[[2,15]])})))()},methods:{closeTopo:function(){this.dialogTopoVisible=!1},handlecloseEvidence:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.dialogEvidenceVisible=!1,e.initAmis();case 2:case"end":return t.stop()}}),t)})))()},reloadCurrent:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.dialogEvidenceVisible=!1,e.initAmis();case 2:case"end":return t.stop()}}),t)})))()},initAmis:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a,n,i,o;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.loading=!0,e.dialog=!1,a=location.hash.split("/")[location.hash.split("/").length-1],t.next=5,Object(p["b"])(a);case 5:n=t.sent,i=n.data,o=void 0===i?{}:i,e.viewData=o.data,console.log("view表单",o),"{}"!=JSON.stringify(e.viewData)&&(e.dialog=!0,e.loading=!1);case 11:case"end":return t.stop()}}),t)})))()},tabHandleClick:function(e){switch(e.name){case"first":break;case"second":break}},visibleInfo:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s,l,d,u;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(n=t,n.collectionInfo=e,n.CardDevice(e.parentId.objectId),n.subRealtimedata(e),a.prev=4,i={},o=[],n.thingdata=[],n.realtimedata=[],n.thingcolumns=[],e.basedata)for(c in e.basedata)0==c.indexOf("dgiot_testing_equipment_")&&(s=c.split("dgiot_testing_equipment_")[1],i["".concat(s)]=s,o.push(e.basedata[c]));return a.next=13,pe({items:o,productid:e.parentId.product.objectId});case 13:l=a.sent,d=l.table,u=void 0===d?[]:d,n.thingcolumns=u,n.historycolumns=_.filter(u,(function(e){return"timestamp"!==e.prop})),n.historycolumns&&(n.historycolumns=e.profile.historicaldatacolumns),n.historydata=e.profile.historicaldata,n.drawdata=e.profile.drawdata,n.featHistoryEvidence(t.collectionInfo.objectId),n.visible=!0,a.next=28;break;case 25:a.prev=25,a.t0=a["catch"](4),console.log(a.t0);case 28:case"end":return a.stop()}}),a,null,[[4,25]])})))()},subRealtimedata:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:"$dg/user/realtimecard/".concat(e.parentId.objectId,"/report");try{t.$dgiotBus.$off("$dg/user/realtimecard"),t.$dgiotBus.$on("$dg/user/realtimecard",(function(a){var n=JSON.parse(c["a"].decode(a.payloadString)),i=n.data,r=void 0===i?[]:i;t.renderCard(r),e.profile.istcp&&Object(S["a"])(e.objectId).then((function(e){t.historyEvidence=e.profile.historicaldata,t.drawdata=e.profile.drawdata})),r?t.collectiontable(r):t.CardDevice()}))}catch(n){console.log(n)}case 2:case"end":return a.stop()}}),a)})))()},collectiontable:function(e){var t=this,a=this,n={};e.forEach((function(e){t.$set(n,e.identifier,e.number),t.$set(n,"timestamp",e.time)})),_.isEmpty(n)||0!=(null===n||void 0===n?void 0:n.dgiotcollectflag)?a.realtimedata.unshift(n):(a.thingdata=[],console.log(n),a.thingdata[0]=n)},featHistoryEvidence:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s,l,d,u;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.historyEvidence=[],n=t.$loading({lock:!0,text:"Loading",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),a.prev=2,i={limit:1,where:{"original.taskid":e,"original.type":"avgs"}},a.next=6,v(i);case 6:o=a.sent,c=o.results,s=void 0===c?[]:c,console.log("queryEvidence",s,t.drawdata),null!==s&&void 0!==s&&s.length?(t.historyEvidence=null!==(l=s[0].original.avgs)&&void 0!==l?l:t.historydata,t.collectionInfo.profile.historicaldata=t.historyEvidence,t.historyInfo=s[0],t.loadfilepath=null!==(d=s[0].original.drawdata.loadfilepath)&&void 0!==d?d:t.drawdata.loadfilepath,t.performancefilepath=null!==(u=s[0].original.drawdata.performancefilepath)&&void 0!==u?u:t.drawdata.performancefilepath,t.performanceremark1=s[0].original.drawdata.performanceremark1,t.performanceremark2=s[0].original.drawdata.performanceremark2,t.performanceremark3=s[0].original.drawdata.performanceremark3,t.loadremark1=s[0].original.drawdata.loadremark1,t.loadremark2=s[0].original.drawdata.loadremark2,t.loadremark3=s[0].original.drawdata.loadremark3):(t.historyEvidence=t.historydata,t.loadfilepath=t.drawdata.loadfilepath,t.performancefilepath=t.drawdata.performancefilepath),console.log("this.loadfilepath",t.loadfilepath),t.$message({message:"数据请求成功",type:"success"}),n.close(),a.next=19;break;case 16:a.prev=16,a.t0=a["catch"](2),n.close();case 19:case"end":return a.stop()}}),a,null,[[2,16]])})))()},CardDevice:function(e){var t=this;Object(S["b"])(e).then((function(e){console.log("实时数据",e),t.machinelist=[],null!==e&&void 0!==e&&e.data&&t.renderCard(e.data)})).catch((function(e){}))},datetime:function(){this.nowTime=Object(ie["a"])()},collection:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s,l,d;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return n=t,n.collectionInfo=e,n.featHistoryEvidence(t.collectionInfo.objectId),a.prev=3,a.next=6,Object(S["a"])(e.objectId);case 6:o=a.sent,c=o.basedata,s=void 0===c?[]:c,l="$dg/thing/".concat(e.parentId.objectId,"/properties/get/request_id=opc_report"),d={cmd:"opc_report",duration:null!==(i=Number(s.dgiot_sampling_parametric_frequency))&&void 0!==i?i:5,groupid:e.objectId},n.$dgiotBus.$emit("MqttPublish",{pubTopic:l,message:JSON.stringify(d),qs:0,status:!1}),a.next=16;break;case 14:a.prev=14,a.t0=a["catch"](3);case 16:case"end":return a.stop()}}),a,null,[[3,14]])})))()},drawxnqx:function(e,t){var a=this;return Object(o["a"])(Object(r["a"])().mark((function n(){var i,o,c,s,l,d,u,p,f,v;return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a.drawxnqxPath="",n.prev=1,i=t,o={data:i,taskid:e},n.next=6,O(o);case 6:c=n.sent,s=c.code,l=c.error,void 0===l?"":l,d=c.original,u=void 0===d?{}:d,p=c.evidenceid,f=void 0===p?"":p,200==Number(s)?(a.historyEvidenceid=null!==f&&void 0!==f?f:"",a.historyEvidence=null!==(v=u.avgs)&&void 0!==v?v:[],a.loadfilepath="".concat(u.drawdata.loadfilepath,"?t=").concat((new Date).getTime()),a.performancefilepath="".concat(u.drawdata.performancefilepath,"?t=").concat((new Date).getTime()),a.performanceremark1=u.drawdata.performanceremark1,a.performanceremark2=u.drawdata.performanceremark2,a.performanceremark3=u.drawdata.performanceremark3,a.original=null!==u&&void 0!==u?u:{},a.drawdata=u.drawdata,a.historycolumns=_.filter(a.thingcolumns,(function(e){return"timestamp"!==e.prop}))):a.$message({message:"请求出错",type:"error"}),n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](1),console.log(n.t0);case 20:case"end":return n.stop()}}),n,null,[[1,17]])})))()},startOpc:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o,c,s,l,d,u;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,i=[],a.next=4,Object(S["a"])(e.objectId);case 4:if(o=a.sent,c=o.basedata,s=void 0===c?[]:c,!_.isEmpty(s))for(l in s)0==l.indexOf("dgiot_testing_equipment_")&&i.push(s[l]);return d="$dg/thing/".concat(e.parentId.objectId,"/properties/get/request_id=opc_items"),u={cmd:"opc_items",groupid:e.objectId,opcserver:null!==(n=s.dgiot_testing_opcserver)&&void 0!==n?n:"Kepware.KEPServerEX.V6",items:i},a.next=12,t.$dgiotBus.$emit("MqttPublish",{pubTopic:d,message:JSON.stringify(u),qs:0,sattus:!1});case 12:a.next=16;break;case 14:a.prev=14,a.t0=a["catch"](0);case 16:case"end":return a.stop()}}),a,null,[[0,14]])})))()},saveHistorical:function(e,t,a,n){var i=this;return Object(o["a"])(Object(r["a"])().mark((function o(){var c,s;return Object(r["a"])().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(c={profile:_.merge(e.profile,{historicaldatacolumns:_.filter(t,(function(e){return"timestamp"!==e.prop})),historicaldata:a,drawdata:i.drawdata})},n&&(i.visible=!1,clearInterval(i.timer)),s=i.$loading({lock:!0,text:"Loading",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),r.prev=3,e.profile.istcp){r.next=7;break}return r.next=7,Object(S["d"])(e.objectId,c);case 7:i.$message({message:"请求成功",type:"success"}),s.close(),r.next=15;break;case 11:r.prev=11,r.t0=r["catch"](3),console.log(r.t0),s.close();case 15:case"end":return r.stop()}}),o,null,[[3,11]])})))()},renderCard:function(e){var t=this,a=[];e.forEach((function(e){e.devicetype&&"dgiotcollectflag"!=e.identifier&&a.push(e.devicetype)})),a=_.uniqBy(a);var n=[];a.forEach((function(t){var a={},i=[];e.forEach((function(e){t==e.devicetype&&i.push(e)})),a["data"]=i,a["name"]=t,n.push(a)})),t.machinelist=n,t.thirdtbKey=(new Date).getTime()},handleCloseAmis:function(){this.management.dialog=!1},handleManagement:function(e){var t=this;return Object(o["a"])(Object(r["a"])().mark((function a(){var n,i,o;return Object(r["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return localStorage.setItem("parse_objectid",e.objectId),localStorage.setItem("product_objectid",e.product.objectId),n={where:{type:"amis",key:e.objectId}},a.next=5,Object(p["d"])(n);case 5:if(i=a.sent,o=i.results,console.log("results",o),!_.isEmpty(o)){a.next=13;break}return t.$message("暂未配置任务表单"),a.abrupt("return",!1);case 13:t.management.dialog=!0,t.management.data=o;case 15:case"end":return a.stop()}}),a)})))()},deleteHistory:function(e,t){var a=this;return Object(o["a"])(Object(r["a"])().mark((function n(){return Object(r["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,a.historyEvidence.splice(t,1);case 3:return console.log("deleteHistory",e,t,a.historyEvidence,a.historyEvidence.length),n.next=6,a.saveHistorical(a.collectionInfo,a.thingdata,a.historyEvidence,!1);case 6:return n.next=8,a.saveThingdata();case 8:n.next=14;break;case 10:n.prev=10,n.t0=n["catch"](0),console.log(n.t0),a.$message({message:"数据请求出错",type:"error"});case 14:case"end":return n.stop()}}),n,null,[[0,10]])})))()},saveThingdata:function(){var e=this;return Object(o["a"])(Object(r["a"])().mark((function t(){var a;return Object(r["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,a={original:e.historyInfo.original},t.next=4,k(e.historyInfo.objectId,a);case 4:t.sent,t.next=11;break;case 7:t.prev=7,t.t0=t["catch"](0),console.log(t.t0),e.$message({message:"数据请求出错",type:"error"});case 11:case"end":return t.stop()}}),t,null,[[0,7]])})))()}},destroyed:function(){}},he=ve,me=(a("f20a"),a("5fa9"),Object(A["a"])(he,n,i,!1,null,"4fb65e87",null));t["default"]=me.exports},d03f:function(e,t,a){"use strict";a("38bc")},d690:function(e,t,a){},f20a:function(e,t,a){"use strict";a("b305")},f2aa:function(e,t,a){"use strict";a("5f51")}}]);